<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Blopinion - Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400;600;700&family=Patrick+Hand&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css" />
</head>

<body class="dash-body">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div style="text-align:center;">
      <h2 class="side-logo">BLOPINION</h2>
      <button class="post-btn" id="openPostModal">Post</button>
    </div>

    <div style="text-align:center;">
      <p id="userEmail" style="font-size:14px;opacity:0.9;margin-bottom:12px;"></p>
      <button id="logoutBtn" class="post-btn transparent-btn">
        Logout
      </button>
    </div>
  </aside>

  <!-- FEED -->
  <main class="feed" id="feed"></main>

  <!-- POST MODAL -->
  <div id="postModal" class="modal hidden">
    <div class="modal-card">
      <h2>Create Post</h2>

      <textarea id="postText" placeholder="Write your opinion..."></textarea>

      <!-- IMAGE PREVIEW -->
      <img id="imagePreview" class="image-preview hidden" />

      <label class="image-upload">
        ðŸ“· Add Image
        <input type="file" id="imageInput" accept="image/*" hidden />
      </label>

      <div class="modal-actions">
        <button id="cancelPost">Cancel</button>
        <button id="submitPost">Post</button>
      </div>

      <p id="postStatus"></p>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- Firebase Config -->
  <script src="js/firebase-config.js"></script>

  <script>
    // ================= INIT =================
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const auth = firebase.auth();
    const db = firebase.firestore();

    const userEmailEl = document.getElementById("userEmail");
    const logoutBtn = document.getElementById("logoutBtn");
    const feed = document.getElementById("feed");

    const postModal = document.getElementById("postModal");
    const openPostModal = document.getElementById("openPostModal");
    const cancelPost = document.getElementById("cancelPost");
    const submitPost = document.getElementById("submitPost");
    const postText = document.getElementById("postText");
    const imageInput = document.getElementById("imageInput");
    const imagePreview = document.getElementById("imagePreview");
    const postStatus = document.getElementById("postStatus");

    // ================= CLOUDINARY =================
    const cloudName = "djkjrowyi";
    const uploadPreset = "blopinion_upload"; // âœ… CORRECT PRESET

    let currentUser = null;

    // ================= AUTH GUARD =================
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.replace("index.html");
      } else {
        currentUser = user;
        userEmailEl.textContent = user.email;
        loadPosts();
      }
    });

    // ================= LOGOUT =================
    logoutBtn.onclick = () => {
      if (!confirm("Are you sure you want to log out?")) return;

      auth.signOut().then(() => {
        window.location.href = "index.html";
      });
    };

    // ================= MODAL =================
    openPostModal.onclick = () => {
      postModal.classList.remove("hidden");
    };

    cancelPost.onclick = () => {
      closeModal();
    };

    function closeModal() {
      postModal.classList.add("hidden");
      postText.value = "";
      imageInput.value = "";
      imagePreview.classList.add("hidden");
      postStatus.textContent = "";
    }

    // ================= IMAGE PREVIEW =================
    imageInput.onchange = () => {
      const file = imageInput.files[0];

      if (!file) {
        imagePreview.classList.add("hidden");
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        imagePreview.src = reader.result;
        imagePreview.classList.remove("hidden");
      };
      reader.readAsDataURL(file);
    };

    // ================= CREATE POST =================
    submitPost.onclick = async () => {
      const text = postText.value.trim();
      const file = imageInput.files[0];

      if (!text) {
        postStatus.style.color = "#ff6b6b";
        postStatus.textContent = "Post cannot be empty";
        return;
      }

      submitPost.disabled = true;
      postStatus.style.color = "white";
      postStatus.textContent = "Posting...";

      let imageUrl = "";

      try {
        // ========== UPLOAD IMAGE ==========
        if (file) {
          const formData = new FormData();
          formData.append("file", file);
          formData.append("upload_preset", uploadPreset);

          const res = await fetch(
            `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`,
            { method: "POST", body: formData }
          );

          const data = await res.json();

          if (!data.secure_url) {
            throw new Error("Image upload failed");
          }

          imageUrl = data.secure_url;
        }

        // ========== SAVE TO FIRESTORE ==========
        await db.collection("posts").add({
          text: text,
          image: imageUrl,
          email: currentUser.email,
          uid: currentUser.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        postStatus.style.color = "#4caf50";
        postStatus.textContent = "Posted successfully!";

        setTimeout(() => {
          closeModal();
          submitPost.disabled = false;
        }, 700);

      } catch (err) {
        console.error(err);
        postStatus.style.color = "#ff6b6b";
        postStatus.textContent = "Failed to post âŒ";
        submitPost.disabled = false;
      }
    };

    // ================= LOAD POSTS =================
    function loadPosts() {
      db.collection("posts")
        .orderBy("createdAt", "desc")
        .onSnapshot(snapshot => {
          feed.innerHTML = "";

          snapshot.forEach(doc => {
            const post = doc.data();

            const card = document.createElement("div");
            card.className = "card";

            const email = document.createElement("p");
            email.style.fontSize = "13px";
            email.style.opacity = "0.7";
            email.innerText = post.email;

            const text = document.createElement("p");
            text.innerText = post.text;

            card.appendChild(email);

            if (post.image) {
              const img = document.createElement("img");
              img.src = post.image;
              card.appendChild(img);
            }

            card.appendChild(text);

            // DELETE BUTTON (OWNER ONLY)
            if (post.uid === currentUser.uid) {
              const delBtn = document.createElement("button");
              delBtn.innerText = "Delete";
              delBtn.className = "delete-btn";

              delBtn.onclick = () => {
                if (confirm("Delete this post?")) {
                  db.collection("posts").doc(doc.id).delete();
                }
              };

              card.appendChild(delBtn);
            }

            feed.appendChild(card);
          });
        });
    }
  </script>

</body>
</html>
